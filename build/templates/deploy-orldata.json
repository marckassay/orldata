{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "resourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "The resource group name for Orldata. Only one instance of this type is needed per subscription."
      }
    },
    "resourceGroupLocation": {
      "type": "string",
      "metadata": {
        "description": "The resource group location."
      }
    },
    "deploymentName": {
      "type": "string",
      "metadata": {
        "description": "The name of the deployment. This can be referenced later in the resourece group setting's deployment blade. This is value is generated by `Get-DeploymentTemplateObject`."
      }
    },
    "containerRegistryCredentials": {
      "type": "array",
      "metadata": {
        "description": "The container registry credentials related to resourceGroupName. Only one instance of this type is needed per subscription."
      }
    },
    "containerDNSName": {
      "type": "string",
      "metadata": {
        "description": "The container dns name. Note, that this is currently used as 'staging' to confirm that container deployment is running as expected before moving to 'prod'."
      }
    },
    "containerTag": {
      "type": "string",
      "metadata": {
        "description": "The container instance to be used for this deployment."
      }
    },
    "sslKey": {
      "type": "string",
      "metadata": {
        "description": "The private ssl key. Must be encoded in base64."
      }
    },
    "sslCrt": {
      "type": "string",
      "metadata": {
        "description": "The ssl certificate. Must be encoded in base64. This is value is generated by `Get-DeploymentTemplateObject`."
      }
    },
    "nginxConf": {
      "type": "string",
      "metadata": {
        "description": "The nginx configuration file. Must be encoded in base64. This is value is generated by `Get-DeploymentTemplateObject`."
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2018-05-01",
      "name": "[parameters('resourceGroupName')]",
      "location": "[parameters('resourceGroupLocation')]",
      "properties": {
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2017-07-01",
      "name": "[parameters('deploymentName')]",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/resourceGroups/', parameters('resourceGroupName'))]"
      ],
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
          },
          "variables": {
          },
          "resources": [
            {
              "type": "Microsoft.ContainerInstance/containerGroups",
              "apiVersion": "2018-10-01",
              "location": "[parameters('resourceGroupLocation')]",
              "name": "orldataContainerGroup",
              "properties": {
                "osType": "Linux",
                "restartPolicy": "Always",
                "imageRegistryCredentials": "[parameters('containerRegistryCredentials')]",
                "ipAddress": {
                  "ports": [
                    {
                      "protocol": "TCP",
                      "port": 443
                    }
                  ],
                  "type": "Public",
                  "dnsNameLabel": "[parameters('containerDNSName')]"
                },
                "containers": [
                  {
                    "name": "orldata-app",
                    "properties": {
                      "image": "[concat(parameters('containerRegistryCredentials').server, '/orldata/prod:', parameters('containerTag'))]",
                      "ports": [
                        {
                          "protocol": "TCP",
                          "port": 443
                        }
                      ],
                      "resources": {
                        "requests": {
                          "memoryInGB": 1.5,
                          "cpu": 1.0
                        }
                      },
                      "volumeMounts": [
                        {
                          "name": "nginx-config",
                          "mountPath": "/etc/nginx",
                          "readOnly": true
                        }
                      ]
                    }
                  }
                ],
                "volumes": [
                  {
                    "name": "nginx-config",
                    "secret": {
                      "ssl.key": "[parameters('sslKey')]",
                      "ssl.crt": "[parameters('sslCrt')]",
                      "nginx.conf": "[parameters('nginxConf')]"
                    }
                  }
                ],
                "command": [
                  "/bin/sh",
                  "-c",
                  "touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600"
                ],
                "livenessProbe": {
                  "exec": {
                    "command": [
                      "cat",
                      "/tmp/healthy"
                    ]
                  },
                  "periodSeconds": 5
                }
              }
            }
          ],
          "outputs": {
            "containerIPv4Address": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerInstance/containerGroups/', 'orldataContainerGroup')).ipAddress.ip]"
            }
          }
        }
      }
    }
  ],
  "outputs": {
  }
}
